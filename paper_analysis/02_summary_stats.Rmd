---
title: "Figures"
author: "Sam Struthers"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
source("paper_analysis/00_analysis_setup.R")

save_plot_image<- function(plot,name){
  
  ggsave(paste0("data/figs_output/2024_figs/",name,".jpg"), dpi = 300, width = 18, height = 10)
  
}

```

# Grab data

###  Chem

### Chem new
```{r}

#discrete sample data and location metadata from most recent pub

DOI = "11110885"
data_version = "v2024.04.16b"


source("paper_analysis/functions/grab_zenodo_data.R")

 all_params <- chem_units%>%
  pull(simple)
```


## Tidy discrete

```{r}
tidy_chem <- most_recent_chem%>%
  #remove random pre fire data
  filter(Year > 2020)%>%
  # pfal + slep represent the same site but were moved to match future sensor location
  mutate(distance_upstream_km = case_when(site_code == "PFAL" ~ 73.9, TRUE ~ distance_upstream_km))%>%
  # add order table which gives the sites an order to be plotted in
  left_join(order_table, by = "site_code")%>%
  mutate(n_nh4 = NH4 * 0.7765, 
         n_no3 = NO3 * 0.2259, 
         DIN = n_nh4 + n_no3,
         DON = DTN - DIN)


#site order now added to tidy chem and thus not needed
rm(order_table, most_recent_chem, DOI, data_version)
print("Data Successfully loaded for analysis")
```


## Run above to get data loaded

```{r}

```


# Reporting Calculations
These data and calculations will be included in the funder report to give an overview of how the system is changing year to year based on our study

## Chlorophyll a status

In cold water lakes (our study sites), mesotrophic levels are defined as between 2.6 and 8 µg/L, and eutrophic levels are greater than 8 µg/L. Under 2.6 µg/L is considered Oligotrophic. 
```{r}

chla_status_site_year <- tidy_chem%>%
  filter(!is.na(ChlA))%>%
  mutate(eu_status  = case_when(ChlA >= 2.6 &ChlA <= 8 ~ "Mesotrophic", 
                                ChlA > 8 ~ "Eutrophic",
                                ChlA < 2.6 ~ "Oligotrophic"))%>%
  group_by(site_code, Year, eu_status)%>%
  summarise(eu_stats = n())%>%
  ungroup()%>%
  pivot_wider(names_from = eu_status, values_from = eu_stats)%>%
  mutate_at(vars(-Year), ~replace(., is.na(.), 0))%>%
  rowwise()%>%
  mutate(total_samples = sum(c(Eutrophic, Mesotrophic, Oligotrophic)),
    perc_eu = round((Eutrophic/total_samples)*100, digits= 1), 
         perc_meso = round((Mesotrophic/total_samples)*100, digits= 1),
         perc_meso_eu = round(((Eutrophic+Mesotrophic)/total_samples)*100, digits= 1), 
        perc_oligo = round((Oligotrophic/total_samples) *100, digits= 1),
    Year = as.character(Year))


long_chla_status <- chla_status_site_year%>%
  select(site_code, Year, total_samples, perc_eu, perc_meso, perc_meso_eu, perc_oligo)%>%
  pivot_longer(cols = c(perc_eu, perc_meso, perc_meso_eu, perc_oligo), names_to = "category", values_to = "value" )

status_plot <- long_chla_status%>%
  filter(site_code %in% mainstem_Res_only )%>%
  ggplot(aes(x = Year, y = value,group = site_code, color =  site_code))+
  scale_color_manual(values = colorsBS_site_code)+
 geom_line()+
   geom_point()+
  theme_bw(base_size = 15)+
facet_wrap(~category)
plot(status_plot)



```

## chla stats

```{r}


chla_per_year <-tidy_chem%>%
  select(ChlA, Year, site_code, Date, watershed)%>%
  na.omit()%>%
  group_by(Year)%>%
  summarise(count_year = n())


chla_per_site_year <-tidy_chem%>%
  select(ChlA, Year, site_code)%>%
  na.omit()%>%
  group_by(Year, site_code)%>%
  summarise(n = n(), 
         mean = mean(ChlA), 
         median = median(ChlA))%>%
  ungroup()%>%
  dplyr::arrange(site_code,Year)

```


# Mean all params

Code to make SI tables for minimum and maximum values 
```{r}

yearly_means <- tidy_chem%>%
  filter(Campaign %nin% c("CLP  Mainstem-Fort Collins","CLP Mainstem-Canyon" )& site_code %nin% c("PJW","JWC"  ,"PBR","PBD", "PNF","PSF","SFM","SAWM", "LDRT1", "legacy","timberline","ELC","archery","PFAL", "BEAV") & Year >= 2021)%>%
  select(-c("data_source","Lat","Long","location_type","Campaign","watershed","burn_status","Buffer_Level","Watershed_Level","distance_upstream_km", "FCW_number", "Field_DO_mgL","Field_Cond_µS_cm","Field_Temp_C"))%>%
  group_by(Year, site_code, Site)%>%
  summarise(across(starts_with(all_params), mean, na.rm = TRUE),
            .groups = 'drop')
 


  
  subset_table <- yearly_means%>%
  mutate(Site = paste0(Site, " (", site_code, ")"))%>%
    #select(Site, Year, `Chlorophyll a (ug/L)` = ChlA,     `SC (uS/cm)` = SC,    pH,    `DOC (mg/L)` = DOC)%>%
  #select(Site, Year,`TDN (mg/L)` = DTN,     `NH4 (mg/L)` = NH4,   	`NO3 (mg/L)` = NO3,   `PO4 (mg/L)` = PO4 )%>%
  #select(Site, Year,`SO4 (mg/L)` = SO4,     `Na (mg/L)` = Na,   	`Ca (mg/L)` = Ca,   `Cl (mg/L)` = Cl )%>%
  select(Site, Year,`K (mg/L)` = K,     `Mg (mg/L)` = Mg,   	`F (mg/L)` = `F`, TSS)%>%
    
  pivot_longer(cols = 
                   #c(`Chlorophyll a (ug/L)`:`DOC (mg/L)`),
                  #c(`TDN (mg/L)`:`PO4 (mg/L)`),
               #c(`SO4 (mg/L)`:`Cl (mg/L)`),
               c(`K (mg/L)`:TSS),
               names_to = "Parameter", values_to = "Value")%>%
  pivot_wider(names_from = c(Parameter, Year), values_from = Value, values_fill = 0)%>%
  select(Site, order(colnames(.)))

  subset_table$Site <- factor(subset_table$Site, levels = c("Barnes Meadow Outflow (BMD)", "Barnes Meadow Reservoir (BRNR)", "Chambers Inlet (CBRI)", "Chambers Reservoir (CBRR)", "Chambers Outflow (CHD)", "Joe Wright Inlet (JOEI)", "Joe Wright Reservoir (JOER)", "Comanche Inflow (COMI)",  "Comanche Reservoir (COMR)", "Comanche Outflow (COMO)", "Hourglass Inflow (HORI)", "Hourglass Reservoir (HORR)", "Hourglass Outflow (HORO)","Long Draw Outlet (LNGO)","Long Draw Reservoir (LNGR)","Peterson Outlet (PTRO)", "Peterson Reservoir (PTRR)"     ))

  #create standard border color and width
  std_border <- fp_border_default(width = 1, color = "black")
  
ft <- flextable(subset_table)%>%
  separate_header() %>%
  align(align = "center", part = "all")%>%
  colformat_double( big.mark = "'", decimal.mark = ".", digits = 2)%>%
  set_table_properties(layout = "fixed")%>%
  border_remove()%>%
  border_outer(part="all", border = std_border )%>%
  border_inner_h(border = std_border, part="all")%>%
   border_inner_v(border = std_border, part="all")%>%
  autofit()%>%
  italic( j = "Site")%>%
  fontsize( size = 8, part = "body")

#Highlighting columns other than Site
# Max is red
# min is blue
columns_to_highlight <- names(subset_table) %>%
  keep(~ !grepl("Site", .))

  for (i in 1:length(columns_to_highlight)) {
    max_color <- "#CC3311"
    min_color <- "#0077BB"
    
    ft <- color(ft, j = i+1, 
                    i = ~ subset_table[i+1] == max(subset_table[i+1], na.rm = TRUE), 
                    color = max_color)
    
    ft <- color(ft, j = i+1, 
                    i = ~ subset_table[i+1] == min(subset_table[i+1], na.rm = TRUE), 
                    color = min_color)
  }
  

ft

  
sect_properties <- prop_section(
  page_size = page_size(
    orient = "landscape",
    width = 8.3, height = 11.7
  ),
  type = "continuous",
  page_margins = page_mar()
)

ft

# Save the table to a Word document
save_as_docx(ft, path = "data/table_export3.docx", pr_section = sect_properties)



```
