---
title: "Longitudinal mapping of Reservoir -> River Connection"
author: "Sam Struthers"
format: html
editor: visual
self-contained: true
---

## Goals

This document is to work on graphs related to nutrients from Reservoirs/ mainstem

### Importing

Loading packages and creating lists of sites based on location/grouping

```{r}
source("package_loader.R")
source("field_chemistry/00_colors_and_groups.R")


reservoir_chemistry <- read_feather("data/field_chemistry/cleaned/reservoir_chem_2021_2022.feather")%>%
  mutate(location = factor(location, levels = c("Inflow","Reservoir", "Outflow", "Stream", "Mainstem")))


```

## Data frame creation

```{r}


res_2021 <- filter(reservoir_chemistry, site_code %in% jw_chambers_complex & Year == 2021)

# filter reservoir chemistry for 2022
# only use sites from all_res_system and mainstem_sites

all_system_2022 <- filter(reservoir_chemistry, site_code %in% c(all_res_system, mainstem_sites) & 
                            Year == 2022)
  filter(Date >= "2022-06-01")
  ## find all the weeks where each site has data for ChlA and name the column all_sites_chla, make it true if all the sites are present
   all_sites_chla <- all_system_2022%>%
     select(ChlA, Date, 
            #Date_week, 
            site_code)%>%
  pad(group = "site_code")%>% 
  thicken('week')
   
   all_sites_true <-all_sites_chla %>%
     summarise(all_sites_chla = all(!is.na(ChlA)))%>%
     ungroup()%>%
     filter(all_sites_chla == TRUE)
     

 

```

## Functionalize pivoting for var

```{r}

get_ratios_2022 <- function(nutrient){
}
  
  nutrient_ratios <- all_system_2022%>%
    dplyr::select(Date,
         site_code,
         nutrient)%>%
  drop_na()%>%
  distinct()%>%
  pivot_wider(names_from = site_code, values_from = nutrient)%>%
    thicken(interval = 'week')
  
  # %>%
  #   filter(Date_week %in% c("2022-08-21",
  #                           "2022-07-24",
  #                           "2022-07-10", 
  #                           "2022-09-04", 
  #                           "2022-09-18",
  #                           "2022-10-02", 
  #                           "2022-10-16"))
  # mutate(jw_ratio = CBRI / JOEI,
  #        chambers_ratio = CHD/ CBRI, 
  #        Year = year(Date))



```

## Functionalize 2021 JOER/CBRR dataset

```{r}

plot_long_jw_ch <- function(param, year = 2021,  title = FALSE){


  ratio_for_param <- filter(reservoir_chemistry, site_code %in% jw_chambers_complex & Year == year)%>%
    dplyr::select(all_of(param), Date, site_code)%>%
     pivot_wider(names_from = site_code, values_from = param)%>%
    drop_na()%>%
    mutate(JOEI_JOER = JOER/JOEI, 
           JOER_CBRI = CBRI/JOER,
           CBRI_CBRR = CBRR/CBRI,
           CBRR_CHD = CHD/CBRR)
  
  
# #create a boxplot of the columns JOEI_JOER, JOER_CBRI, CBRI_CBRR and CBRR_CHD
#   boxplot(ratio_for_param[,c("JOEI_JOER", "JOER_CBRI", "CBRI_CBRR", "CBRR_CHD")],
#           main = paste0("Boxplot of ", param, " ratios for 2021"),
#           xlab = "Site",
#           ylab = "Ratio",
#           col = "lightblue",
#           names = c("JOEI/JOER", "JOER/CBRI", "CBRI/CBRR", "CBRR/CHD"))
  
# create a mean_2021 dataframe that has the mean of JOEI, JOER, CBRI, CBRR and CHD
#pivot longer and name the columns "site" and "value"
  mean_2021 <- ratio_for_param%>%
    pivot_longer(cols = c("JOEI", "JOER", "CBRI", "CBRR", "CHD"),
                 names_to = "site",
                 values_to = "value")%>%
    group_by(site)%>%
    summarise(mean = mean(value), 
              sd = sd(value))%>%
    ungroup()%>%
    mutate(site = factor(site, levels = c("JOEI", "JOER", "CBRI", "CBRR", "CHD")), 
           mean_plus_sd = mean + sd, 
           mean_minus_sd = mean - sd, 
           type = "mean")
  
  no_ratios_2021 <- ratio_for_param%>%
    pivot_longer(cols = c("JOEI", "JOER", "CBRI", "CBRR", "CHD"),
                 names_to = "site",
                 values_to = "value")%>%
     mutate(site = factor(site, levels = c("JOEI", "JOER", "CBRI", "CBRR", "CHD")))

 if(title == TRUE){
 plot <- ggplot(mean_2021, aes(x = site))+
   geom_point(data = no_ratios_2021, aes(y = value, color = site), alpha  = .6)+
   geom_ribbon(aes(ymin = mean_minus_sd, ymax = mean_plus_sd, 
                  group = type), alpha = 0.2)+
   geom_point(aes(y = mean))+
   geom_line(aes( y = mean, group = type))+
   scale_color_manual(values = colorsBS_in_order)+
   theme_few(base_size = 20) +
   labs(x = "Site (Upstream to Downstream)", 
        y = param)+
   #add the year in the top left quadrant of the plot
    annotate("text", x = 1, y = 1.5, label = year, size = 10)+
    theme(legend.position = "none")
}
  
  if(title == FALSE){
 plot <- ggplot(mean_2021, aes(x = site))+
   geom_point(data = no_ratios_2021, aes(y = value, color = site), alpha  = .6)+
   geom_ribbon(aes(ymin = mean_minus_sd, ymax = mean_plus_sd, 
                  group = type), alpha = 0.2)+
   geom_point(aes(y = mean))+
   geom_line(aes( y = mean, group = type))+
   scale_color_manual(values = colorsBS_in_order)+
   theme_few(base_size = 20) +
   labs(x = "Site (Upstream to Downstream)", 
        y = param)+
        
        #remove x axis labels and title
      theme(axis.text.x = element_blank(),
            axis.ticks.x = element_blank(),
            axis.title.x = element_blank())+
    theme(legend.position = "none")
}
 return(plot)
}
```

## Param long 2021 JW CH plots

```{r}
# run the function for each parameter: ChlA, NO3, PO4, NH4, DOC, DTN, pH, SO4, K
# save each plot as a variable

no3 <- plot_long_jw_ch_2021(param = "NO3")
nh4 <- plot_long_jw_ch_2021(param = "NH4")
doc <- plot_long_jw_ch_2021(param = "DOC")
dtn <- plot_long_jw_ch_2021(param = "DTN")
ph <- plot_long_jw_ch_2021(param = "pH")
so4 <- plot_long_jw_ch_2021(param = "SO4")
k <- plot_long_jw_ch_2021(param = "K", title = TRUE)
chlA <- plot_long_jw_ch_2021(param = "ChlA", title = TRUE)
tss <- plot_long_jw_ch_2021(param = "TSS")
turbidity <- plot_long_jw_ch_2021(param = "Turbidity", title = TRUE)

#arrange the plots in a grid
ggarrange(no3, nh4, doc, dtn, ph, so4, k, chlA, ncol = 2, nrow = 4)



no3_2021 <- plot_long_jw_ch(param = "NO3", year = 2021)
no3_2022 <- plot_long_jw_ch(param = "NO3", year = 2022, title = TRUE)
chla_2021 <- plot_long_jw_ch(param = "ChlA", year = 2021)
chla_2022 <- plot_long_jw_ch(param = "ChlA", year = 2022, title = TRUE)

ggarrange(chla_2021, no3_2021, chla_2022, no3_2022, ncol = 2, nrow = 2)
ggsave("output/chla_no3_JW_CH_facet_mean_sd.jpg", width = 24, height = 16, dpi = 300)
```





